// âœ… SORA Dashboard Script Base - CoreMasterå°‚ç”¨ç°¡ç•¥ç‰ˆï¼ˆè¦³å…‰å‹å»ƒæ­¢ï¼‰
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById("detailModal");
  const modalBody = document.getElementById("modalBody");
  const closeBtn = document.getElementById("closeModal");

  const compareListContainer = document.getElementById("compareListContainer");

  // ä¸è¦ãªæ—§UIè¦ç´ ã‚’æ“ä½œã—ãªã„

  // âœ… GPTèª²é¡ŒæŠ½å‡ºç”¨å‡¦ç†ã¯ãã®ã¾ã¾ç¶­æŒ
  const analyzeBtn = document.getElementById('analyzeBtn');
  analyzeBtn.addEventListener("click", async () => {
    const regionName = document.getElementById("regionName").value.trim();
    const userNote = document.getElementById("userNote").value.trim();

    updateGoogleMap(regionName);
    if (!regionName || !userNote) {
      alert("åœ°åŸŸåã¨ãƒ†ãƒ¼ãƒã¯ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const originalBtnText = analyzeBtn.innerText;
    analyzeBtn.innerText = "èª²é¡ŒæŠ½å‡ºä¸­â€¦";
    analyzeBtn.disabled = true;

    const prompt = `${regionName}ã«ã¤ã„ã¦ã€ãƒ†ãƒ¼ãƒã€Œ${userNote}ã€ã«åŸºã¥ãåœ°åŸŸèª²é¡Œã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚\nä»¥ä¸‹ã®å†…å®¹ã«ã¤ã„ã¦ã€æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°500ä»¥å†…ã§ã€æœ€å¤§5ã¤ã¾ã§ã®åœ°åŸŸèª²é¡Œã‚’ç°¡æ½”ã«æŒ™ã’ã¦ãã ã•ã„ã€‚å„èª²é¡Œã¯1ã€œ2æ–‡ã§è¨˜è¿°ã—ã€åŸå› ã‚„èƒŒæ™¯ãŒç°¡æ½”ã«åˆ†ã‹ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚`;

    try {
      await fetchChatGPTResponse(prompt);
    } catch (error) {
      console.error("æŠ½å‡ºä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
      alert("èª²é¡ŒæŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    } finally {
      analyzeBtn.innerText = originalBtnText;
      analyzeBtn.disabled = false;
    }
  });

  async function fetchChatGPTResponse(prompt) {
    const response = await fetch("/api/chatgpt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    if (!response.ok) throw new Error("ChatGPT APIã‚¨ãƒ©ãƒ¼");
    const data = await response.json();
    const canvasResult = document.getElementById("canvasResult");
    canvasResult.innerText = data.result || "çµæœãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
  }

  // âœ… åœ°å›³å–å¾—éƒ¨åˆ†ã¯ç¶­æŒ
  const nexcoBtn = document.getElementById("toggleNexcoBtn");
  const infoBox = document.getElementById("nexcoInfoBox");
  const infoList = document.getElementById("nexcoInfoList");
  const statusBox = document.getElementById("nexcoStatus");
  let infoFetched = false;
  let isAccordionOpen = false;
  let isFetching = false;

  nexcoBtn.addEventListener("click", () => {
    const region = document.getElementById("regionName").value.trim();
    if (!region) {
      alert("åœ°åŸŸåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    if (!infoFetched && !isFetching) {
      isFetching = true;
      nexcoBtn.textContent = "NEXCOæƒ…å ± å–å¾—ä¸­â€¦";

      const prompt = `${region}å‘¨è¾ºã®é«˜é€Ÿé“è·¯ã«é–¢ã™ã‚‹ã€ä¸»ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒã‚§ãƒ³ã‚¸ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒªã‚¢ã€ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°ã‚¨ãƒªã‚¢ã‚’æœ€å¤§5ã€œ7ä»¶ç¨‹åº¦ã€ãƒªã‚¹ãƒˆå½¢å¼ã§ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚å„æ–½è¨­åã¨ç°¡å˜ãªç‰¹å¾´ï¼ˆä¾‹ï¼šãƒˆã‚¤ãƒ¬ã€é£²é£Ÿã€ã‚¬ã‚½ãƒªãƒ³æœ‰ç„¡ãªã©ï¼‰ã ã‘ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚ãã‚Œä»¥å¤–ã®æƒ…å ±ã¯ä¸è¦ã§ã™ã€‚`;

      fetch("/api/chatgpt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      })
        .then(response => {
          if (!response.ok) throw new Error("å–å¾—å¤±æ•—");
          return response.json();
        })
        .then(data => {
          const raw = data.result || "";
          const items = raw.split(/[
ãƒ»ã€‚ï¼ï¼Ÿ]/).filter(line => line.trim().length > 4);
          infoList.innerHTML = "";
          items.forEach(text => {
            const li = document.createElement("li");
            li.textContent = text.trim();
            infoList.appendChild(li);
          });

          infoFetched = true;
          isFetching = false;
          infoBox.classList.add("open");
          isAccordionOpen = true;
          updateButtonLabel();
        })
        .catch(error => {
          console.error("ğŸ”¥ å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
          infoList.innerHTML = "<li>æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</li>";
          nexcoBtn.textContent = "NEXCOæƒ…å ±ã‚’è¡¨ç¤º";
          isFetching = false;
        });
    } else {
      if (!isAccordionOpen) {
        infoBox.classList.add("open");
        isAccordionOpen = true;
      } else {
        infoBox.classList.remove("open");
        isAccordionOpen = false;
      }
      updateButtonLabel();
    }
  });

  function updateButtonLabel() {
    nexcoBtn.textContent = isAccordionOpen ? "NEXCOæƒ…å ±ã‚’é–‰ã˜ã‚‹" : "NEXCOæƒ…å ±ã‚’è¡¨ç¤º";
    if (statusBox) {
      statusBox.textContent = isAccordionOpen ? "NEXCOæƒ…å ±ã‚’è¡¨ç¤ºä¸­" : "NEXCOæƒ…å ±ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ";
    }
  }
});
