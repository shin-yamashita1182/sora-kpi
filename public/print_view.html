<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>印刷ビューア - 出力統合メニュー</title>

  <style>
  /* ===== 画面表示用スタイル ===== */
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f8f9fa;
  }

  header {
    background-color: #0077cc;
    color: white;
    padding: 1rem 2rem;
    font-size: 1.4rem;
    font-weight: bold;
    text-align: center;
  }

  #menu {
    display: flex;
    justify-content: center;
    gap: 1rem;
    padding: 1rem;
    background-color: #e9ecef;
  }

  #menu button {
    background-color: #2a9d8f;
    border: none;
    color: white;
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
  }

  #menu button:hover {
    background-color: #21867a;
  }

  /* ✅ 🎯 印刷ボタンだけ別色に（@media の外に出す！） */
  #menu #printBtn {
    background-color: #6c757d;
    color: white;
  }

  #menu #printBtn:hover {
    background-color: #5a6268;
  }

  #content {
    padding: 2rem;
    text-align: center;
  }

  .section-container {
    margin-top: 2rem;
    border-top: 1px solid #ccc;
    padding-top: 1rem;
  }

  #mindmapMetadata {
    text-align: left;
    margin-bottom: 1rem;
    background: #fff;
    border: 1px solid #ccc;
    padding: 1rem;
    border-radius: 6px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  #mindmapImage {
    display: block;
    margin: 1rem auto;
    max-width: 100%;
    border: 1px solid #999;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  /* ===== 印刷時専用スタイル ===== */
  @media print {
    body * {
      visibility: hidden;
    }

    .print-area,
    .print-area * {
      visibility: visible;
    }

    .print-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: white;
      padding: 2rem;
    }

    header,
    #menu,
    #detailSections {
      display: none !important;
    }
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body>
  <header>🖨️ 印刷・出力ビューア</header>

  <!-- ✅ 総合メニュー -->
  <div id="menu">
    <button onclick="loadSection('mindmap')">🧠 マインドマップ単体</button>
    <button onclick="loadSection('summary')">📊 統合出力（レポート）</button>
    <button onclick="loadSection('cards')">📇 実行策一覧</button>
    <button onclick="loadSection('3d')">🌐 3Dビューア</button>
    <button id="printBtn" onclick="window.print()">🖨️ 印刷</button>  </div>

  <div id="content" class="print-area">
    <p>出力内容を選択してください。</p>
  </div>

  <!-- ✅ 統合出力などの追加UI領域 -->
  <div class="section-container" id="detailSections"></div>

  <script>
 
    function loadSection(type) {
      console.log("loadSection called with type:", type); // ← 追加
      const sessionKey = localStorage.getItem("selectedSessionKey");   
      const sessionData = sessionKey ? JSON.parse(localStorage.getItem(sessionKey)) : null;
      const content = document.getElementById("content");
      const details = document.getElementById("detailSections");
      content.innerHTML = "";
      details.innerHTML = "";

      
  if (type === "mindmap") {
  const region = sessionData?.region || localStorage.getItem("region") || "地域未設定";
  const theme = sessionData?.theme || localStorage.getItem("theme") || "テーマ未設定";
  const imageData = sessionData?.mindmapImageData || sessionData?.png || localStorage.getItem("mindmapImageData");
  const dateStr = new Date().toLocaleDateString();

  // ✅ Base64 PNG形式であることを厳密チェック
  if (!imageData || !imageData.startsWith("data:image/png;base64,")) {
    const warning = document.createElement("p");
    warning.textContent = "❌ マインドマップ画像が存在しません、または形式が不正です。保存に失敗した可能性があります。";
    warning.style.color = "red";
    content.appendChild(warning);
    return;
  }

  // ✅ 表示用のメタデータ（印刷には含めない）
  const metadata = document.createElement("div");
  metadata.id = "mindmapMetadata";
  metadata.innerHTML = `
    <h2>🧠 マインドマップ出力</h2>
    <p><strong>地域名：</strong>${region}</p>
    <p><strong>テーマ：</strong>${theme}</p>
    <p><strong>出力日：</strong>${dateStr}</p>
  `;

  // ✅ PNG画像表示エリア
  const img = document.createElement("img");
  img.id = "mindmapImage";
  img.src = imageData;
  img.alt = "マインドマップ画像";
  img.style.maxWidth = "100%";
  img.style.height = "auto";
  img.style.border = "1px solid #ccc";
  img.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";

  // ✅ 印刷対象としてラップ
  const printable = document.createElement("div");
  printable.className = "print-area";
  printable.appendChild(img);

  // ✅ 画面表示に追加
  content.appendChild(metadata);
  content.appendChild(printable);
  details.innerHTML = "<p style='margin-top: 1rem;'>このマインドマップは、地域の課題と構造的な思考を可視化した資料です。今後の対策立案や共有に活用できます。</p>";

  
      } else if (type === "summary") {
  const region = sessionData?.region || "地域未設定";
  const theme = sessionData?.theme || "テーマ未設定";
  const tasks = sessionData?.tasks || [];
  const insights = sessionData?.insights || "";
  const imageData = sessionData?.mindmapImageData || "";
  const nexcoInfo = sessionData?.nexcoInfo || "[NEXCO情報はまだ登録されていません]";
  const mapImageData = sessionData?.mapImageData || ""; // ✅ 地図画像の取得

  // 🔵 表示専用タイトル
  const heading = document.createElement("h2");
  heading.textContent = "📊 総合出力レポート";

  // 🔵 印刷対象エリアの中身
  const printable = document.createElement("div");
  printable.className = "print-area";
  printable.style.textAlign = "left";

  // 地域名＋テーマ
  printable.innerHTML += `<h3>地域名：${region}</h3><p><strong>テーマ：</strong>${theme}</p>`;

  // 課題リスト
  if (Array.isArray(tasks) && tasks.length > 0) {
    printable.innerHTML += "<h4>抽出された10の課題：</h4><ol>";
    tasks.forEach(task => {
      printable.innerHTML += `<li>${task}</li>`;
    });
    printable.innerHTML += "</ol>";
  }

  // 考察エリア
  printable.innerHTML += `<h4>住民の考察・分析コメント：</h4><p>${insights || "（未入力）"}</p>`;

  // ✅ 地図画像を表示（もしあれば）
  if (mapImageData && mapImageData.startsWith("data:image/png")) {
    printable.innerHTML += `<h4>地域マップ：</h4><img src="${mapImageData}" alt="地図画像" style="max-width:100%; border:1px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">`;
  }

  // ✅ マインドマップ画像
  if (imageData) {
    printable.innerHTML += `<h4>マインドマップ：</h4><img src="${imageData}" alt="マインドマップ" style="max-width:100%; border:1px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">`;
  }

  // ✅ NEXCO情報
  printable.innerHTML += `<h4>NEXCO連携情報：</h4><p>${nexcoInfo}</p>`;

  content.appendChild(heading);
  content.appendChild(printable);
  details.innerHTML = "<p>このエリアには地域全体の課題構造と住民の分析を統合表示します。</p>";

      
     } else if (type === "cards") {
  // 表示用タイトル（印刷時には非表示）
  const heading = document.createElement("h2");
  heading.textContent = "📇 実行策一覧出力（マインドトリガーカード）";

  // 印刷＆表示共通：マインドトリガーカードを並べるコンテナ
  const cardContainer = document.createElement("div");
  cardContainer.className = "print-area"; // ✅ 印刷対象はこの中だけ
  cardContainer.style.display = "grid";
  cardContainer.style.gridTemplateColumns = "repeat(auto-fit, minmax(280px, 1fr))";
  cardContainer.style.gap = "1rem";
  cardContainer.style.padding = "1rem";

  // 🔽 デモ用：絞り込み結果の仮カードを表示（後でベクトル抽出結果に差し替え）
  const sampleCards = [
    { strategy: "地域医療体制の強化", action: "医療人材誘致・遠隔診療拠点の整備" },
    { strategy: "移住定住促進の基盤構築", action: "空き家バンクとリノベーション補助" },
    { strategy: "観光資源の魅力最大化", action: "地域ガイド養成・体験コンテンツ創出" }
  ];

  sampleCards.forEach(cardData => {
    const card = document.createElement("div");
    card.style.border = "1px solid #ccc";
    card.style.borderRadius = "10px";
    card.style.padding = "1rem";
    card.style.backgroundColor = "#fff";
    card.innerHTML = `
      <h4 style="margin-top:0;">${cardData.strategy}</h4>
      <p style="margin-bottom:0.5rem;">${cardData.action}</p>
      <small style="color:gray;">※ KPIはカード詳細に記載</small>
    `;
    cardContainer.appendChild(card);
  });

  // ブラウザ表示に追加（タイトル + カード）
  content.appendChild(heading);
  content.appendChild(cardContainer);

  details.innerHTML = "<p>このエリアにはマインドマップと連動する優先実行策（Mind Trigger Cards）が表示されます。</p>";


      } else if (type === "3d") {
        window.open("3d_viewer.html", "_blank");
      }
    }
    window.addEventListener("DOMContentLoaded", () => {
  const sessionKey = localStorage.getItem("selectedSessionKey");
  const sessionData = sessionKey ? JSON.parse(localStorage.getItem(sessionKey)) : null;
  if (sessionData?.mindmapImageData) {
   
  }
});
  </script>
</body>
</html>
