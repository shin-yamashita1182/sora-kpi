<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å°åˆ·ãƒ“ãƒ¥ãƒ¼ã‚¢ - å‡ºåŠ›çµ±åˆãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>

    <!-- âœ… æ­£ã—ãã¯ã“ã®ã‚ˆã†ã«ãƒ‘ã‚¹ã‚’æŒ‡å®š -->
<link rel="stylesheet" href="test-validation/style.css">


<style>
/* ===== ç”»é¢è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« ===== */
body {
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f8f9fa;
}

header {
  background-color: #0077cc;
  color: white;
  padding: 1rem 2rem;
  font-size: 1.4rem;
  font-weight: bold;
  text-align: center;
}

#menu {
  display: flex;
  justify-content: center;
  gap: 1rem;
  padding: 1rem;
  background-color: #e9ecef;
}

#menu button {
  background-color: #2a9d8f;
  border: none;
  color: white;
  padding: 10px 20px;
  font-size: 1rem;
  border-radius: 6px;
  cursor: pointer;
}

#menu button:hover {
  background-color: #21867a;
}

/* å°åˆ·ãƒœã‚¿ãƒ³ã ã‘åˆ¥è‰² */
#menu #printBtn {
  background-color: #6c757d;
  color: white;
}

#menu #printBtn:hover {
  background-color: #5a6268;
}

#content {
  padding: 2rem;
  text-align: center;
}

.section-container {
  margin-top: 2rem;
  border-top: 1px solid #ccc;
  padding-top: 1rem;
}

#mindmapMetadata {
  text-align: left;
  margin-bottom: 1rem;
  background: #fff;
  border: 1px solid #ccc;
  padding: 1rem;
  border-radius: 6px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}

#mindmapImage {
  display: block;
  margin: 1rem auto;
  max-width: 100%;
  border: 1px solid #999;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

/* ===== Mind Trigger ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºèª¿æ•´ï¼ˆç”»é¢ç”¨ï¼‰ ===== */
.card-header {
  text-align: left;
}
/* âœ… ã‚¿ã‚¤ãƒˆãƒ«ä½ç½®èª¿æ•´ */
.card h2 {
  margin-top: 1rem;
  font-size: 1.1rem;
  text-align: center;
}

.detail-button,
.add-priority-button {
  width: 90%;
  max-width: 260px;
  padding: 0.6rem 0;
  font-size: 1rem;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  display: block;
  text-align: center;
}

.detail-button {
  background-color: #28a745; /* ç·‘ */
  color: white;
}

.add-priority-button {
  background-color: #007bff; /* é’ */
  color: white;
}

.card .card-header + h2 + div {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  margin-top: 1rem;
}

/* ===== å°åˆ·æ™‚å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« ===== */
@media print {
  body * {
    visibility: hidden;
  }

  .print-area,
  .print-area * {
    visibility: visible;
  }

  .print-area {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    background: white;
    padding: 2rem;
  }

  header,
  #menu,
  #detailSections {
    display: none !important;
  }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body>
  <header>ğŸ–¨ï¸ å°åˆ·ãƒ»å‡ºåŠ›ãƒ“ãƒ¥ãƒ¼ã‚¢</header>

  <!-- âœ… ç·åˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="menu">
    <button onclick="loadSection('mindmap')">ğŸ§  ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—å˜ä½“</button>
    <button onclick="loadSection('summary')">ğŸ“Š çµ±åˆå‡ºåŠ›ï¼ˆãƒ¬ãƒãƒ¼ãƒˆï¼‰</button>
    <button onclick="loadSection('cards')">ğŸ“‡ å®Ÿè¡Œç­–ä¸€è¦§</button>
    <button onclick="loadSection('3d')">ğŸŒ 3Dãƒ“ãƒ¥ãƒ¼ã‚¢</button>
    <button id="printBtn" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>  </div>

  <div id="content" class="print-area">
    <p>å‡ºåŠ›å†…å®¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
  </div>

  <!-- âœ… çµ±åˆå‡ºåŠ›ãªã©ã®è¿½åŠ UIé ˜åŸŸ -->
  <div class="section-container" id="detailSections"></div>

  <script>
 
    function loadSection(type) {
      console.log("loadSection called with type:", type); // â† è¿½åŠ 
      const sessionKey = localStorage.getItem("selectedSessionKey");   
      const sessionData = sessionKey ? JSON.parse(localStorage.getItem(sessionKey)) : null;
      const content = document.getElementById("content");
      const details = document.getElementById("detailSections");
      content.innerHTML = "";
      details.innerHTML = "";

      
  if (type === "mindmap") {
  const region = sessionData?.region || localStorage.getItem("region") || "åœ°åŸŸæœªè¨­å®š";
  const theme = sessionData?.theme || localStorage.getItem("theme") || "ãƒ†ãƒ¼ãƒæœªè¨­å®š";
  const imageData = sessionData?.mindmapImageData || sessionData?.png || localStorage.getItem("mindmapImageData");
  const dateStr = new Date().toLocaleDateString();

  // âœ… Base64 PNGå½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’å³å¯†ãƒã‚§ãƒƒã‚¯
  if (!imageData || !imageData.startsWith("data:image/png;base64,")) {
    const warning = document.createElement("p");
    warning.textContent = "âŒ ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ç”»åƒãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€ã¾ãŸã¯å½¢å¼ãŒä¸æ­£ã§ã™ã€‚ä¿å­˜ã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
    warning.style.color = "red";
    content.appendChild(warning);
    return;
  }

  // âœ… è¡¨ç¤ºç”¨ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆå°åˆ·ã«ã¯å«ã‚ãªã„ï¼‰
  const metadata = document.createElement("div");
  metadata.id = "mindmapMetadata";
  metadata.innerHTML = `
    <h2>ğŸ§  ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—å‡ºåŠ›</h2>
    <p><strong>åœ°åŸŸåï¼š</strong>${region}</p>
    <p><strong>ãƒ†ãƒ¼ãƒï¼š</strong>${theme}</p>
    <p><strong>å‡ºåŠ›æ—¥ï¼š</strong>${dateStr}</p>
  `;

  // âœ… PNGç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢
const img = document.createElement("img");
img.id = "mindmapImage";
img.src = imageData;
img.alt = "ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ç”»åƒ";

// âœ… ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ï¼ˆã“ã“ãŒè‚ï¼ï¼‰
img.style.width = "100%";
img.style.maxWidth = "1400px";  // å¥½ã¿ã«å¿œã˜ã¦1200ã€œ1600pxç¨‹åº¦
img.style.height = "auto";
img.style.display = "block";
img.style.margin = "1rem auto";
img.style.border = "1px solid #ccc";
img.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";

  // âœ… å°åˆ·å¯¾è±¡ã¨ã—ã¦ãƒ©ãƒƒãƒ—
  const printable = document.createElement("div");
  printable.className = "print-area";
  printable.appendChild(img);

  // âœ… ç”»é¢è¡¨ç¤ºã«è¿½åŠ 
  content.appendChild(metadata);
  content.appendChild(printable);
  details.innerHTML = "<p style='margin-top: 1rem;'>ã“ã®ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã¯ã€åœ°åŸŸã®èª²é¡Œã¨æ§‹é€ çš„ãªæ€è€ƒã‚’å¯è¦–åŒ–ã—ãŸè³‡æ–™ã§ã™ã€‚ä»Šå¾Œã®å¯¾ç­–ç«‹æ¡ˆã‚„å…±æœ‰ã«æ´»ç”¨ã§ãã¾ã™ã€‚</p>";

  
      } else if (type === "summary") {
  const region = sessionData?.region || "åœ°åŸŸæœªè¨­å®š";
  const theme = sessionData?.theme || "ãƒ†ãƒ¼ãƒæœªè¨­å®š";
  const tasks = sessionData?.tasks || [];
  const category = sessionData?.category || "åˆ†é¡æœªè¨­å®š";
  const insightRaw = sessionData?.insight || [];
  const insights = Array.isArray(insightRaw)
    ? insightRaw.map(line => `ãƒ»${line}`).join("<br>")
    : insightRaw || "ï¼ˆæœªå…¥åŠ›ï¼‰";
  const imageData = sessionData?.mindmapImageData || "";
  const nexcoInfo = sessionData?.nexcoInfo || "[NEXCOæƒ…å ±ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“]";
  const mapImageData = sessionData?.mapImageData || "";

  const heading = document.createElement("h2");
  heading.textContent = "ğŸ“Š ç·åˆå‡ºåŠ›ãƒ¬ãƒãƒ¼ãƒˆ";

  const printable = document.createElement("div");
  printable.className = "print-area";
  printable.style.textAlign = "left";

  // åœ°åŸŸåï¼‹ãƒ†ãƒ¼ãƒï¼‹åˆ†é¡
  printable.innerHTML += `<h3>åœ°åŸŸåï¼š${region}</h3><p><strong>ãƒ†ãƒ¼ãƒï¼š</strong>${theme}</p><p><strong>åˆ†é¡ï¼š</strong>${category}</p>`;

  // èª²é¡Œ
  if (Array.isArray(tasks) && tasks.length > 0) {
    printable.innerHTML += "<h4>æŠ½å‡ºã•ã‚ŒãŸ10ã®èª²é¡Œï¼š</h4><ol>";
    tasks.forEach(task => {
      printable.innerHTML += `<li>${task}</li>`;
    });
    printable.innerHTML += "</ol>";
  }

  // è€ƒå¯Ÿ
  printable.innerHTML += `<h4>ä½æ°‘ã®è€ƒå¯Ÿãƒ»åˆ†æã‚³ãƒ¡ãƒ³ãƒˆï¼š</h4><p>${insights}</p>`;

 // åœ°åŸŸåã«åŸºã¥ã„ãŸGoogleãƒãƒƒãƒ—è¡¨ç¤º
const mapQuery = encodeURIComponent(region);
printable.innerHTML += `
  <h4>åœ°åŸŸãƒãƒƒãƒ—ï¼š</h4>
  <iframe
    width="100%"
    height="300"
    style="border:1px solid #ccc; border-radius:8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);"
    loading="lazy"
    allowfullscreen
    referrerpolicy="no-referrer-when-downgrade"
    src="https://maps.google.com/maps?q=${mapQuery}&output=embed">
  </iframe>
`;

  // ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—
  if (imageData) {
  printable.innerHTML += `<h4>ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ï¼š</h4>
<img src="${imageData}" alt="ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—" 
style="width:100%; max-width:1400px; height:auto; border:1px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display:block; margin:1rem auto;">`;
  }

  // NEXCOæƒ…å ±
  printable.innerHTML += `<h4>NEXCOé€£æºæƒ…å ±ï¼š</h4><p>${nexcoInfo}</p>`;

  content.appendChild(heading);
  content.appendChild(printable);
  details.innerHTML = "<p>ã“ã®ã‚¨ãƒªã‚¢ã«ã¯åœ°åŸŸå…¨ä½“ã®èª²é¡Œæ§‹é€ ã¨ä½æ°‘ã®åˆ†æã‚’çµ±åˆè¡¨ç¤ºã—ã¾ã™ã€‚</p>";

    
     } else if (type === "cards") {
  const heading = document.createElement("h2");
  heading.textContent = "ğŸ“‡ å®Ÿè¡Œç­–ä¸€è¦§å‡ºåŠ›ï¼ˆMindTriggerã‚«ãƒ¼ãƒ‰ï¼‰";

  const cardContainer = document.createElement("div");
  cardContainer.className = "print-area";
  cardContainer.style.display = "flex";
  cardContainer.style.flexWrap = "wrap";
  cardContainer.style.gap = "1rem";
  cardContainer.style.justifyContent = "flex-start";

  fetch("test-validation/coremaster_real_401cards.json")
    .then(res => res.json())
    .then(strategyCards => {
      if (!Array.isArray(strategyCards) || strategyCards.length === 0) {
        const warning = document.createElement("p");
        warning.textContent = "âŒ ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã•ã‚Œã¾ã—ãŸãŒã€ç©ºã§ã™ã€‚";
        warning.style.color = "red";
        content.appendChild(heading);
        content.appendChild(warning);
        return;
      }

      strategyCards.forEach(item => {
        const card = createCard(item);
        cardContainer.appendChild(card);
      });

      content.appendChild(heading);
      content.appendChild(cardContainer);
      details.innerHTML = "<p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ã€<strong>CoreMaster401ä»¶</strong>ã®å®Ÿè¡Œç­–ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>";
    })
    .catch(err => {
      content.appendChild(heading);
      const warning = document.createElement("p");
      warning.textContent = "âŒ ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ã‚„JSONæ§‹é€ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      warning.style.color = "red";
      content.appendChild(warning);
      console.error("èª­ã¿è¾¼ã¿å¤±æ•—:", err);
    });

      
 } else if (type === "3d") {
    window.open("3d_viewer.html", "_blank");
  }
} // âœ… â† loadSection() é–¢æ•°ã‚’ã“ã“ã§æ­£ã—ãé–‰ã˜ã‚‹ï¼

    
function convertTagClass(perspective = "") {
  if (perspective.includes("è²¡å‹™")) return "finance";
  if (perspective.includes("é¡§å®¢")) return "customer";
  if (perspective.includes("ãƒ—ãƒ­ã‚»ã‚¹")) return "process";
  if (perspective.includes("å­¦ç¿’")) return "growth";
  return "finance";
}

function getFullPerspectiveName(perspective = "") {
  if (perspective.includes("è²¡å‹™")) return "è²¡å‹™ã®è¦–ç‚¹";
  if (perspective.includes("é¡§å®¢")) return "é¡§å®¢ã®è¦–ç‚¹";
  if (perspective.includes("ãƒ—ãƒ­ã‚»ã‚¹")) return "å†…éƒ¨ãƒ—ãƒ­ã‚»ã‚¹ã®è¦–ç‚¹";
  if (perspective.includes("å­¦ç¿’")) return "å­¦ç¿’ã¨æˆé•·ã®è¦–ç‚¹";
  return "è¦–ç‚¹æœªè¨­å®š";
}

function getPerspectiveAnnotation(perspective = "") {
  if (perspective.includes("è²¡å‹™")) return "åœ°åŸŸãƒ»ä¼æ¥­ãŒæŒç¶šçš„ã«æˆé•·ã™ã‚‹ãŸã‚ã®çµŒæ¸ˆçš„æˆæœã‚„è³‡æºã®æœ€é©åŒ–";
  if (perspective.includes("é¡§å®¢")) return "ä½æ°‘ãƒ»æ¥è¨ªè€…ãªã©å¤–éƒ¨é–¢ä¿‚è€…ã¸ã®ä¾¡å€¤æä¾›ã¨æº€è¶³åº¦ã®å‘ä¸Š";
  if (perspective.includes("ãƒ—ãƒ­ã‚»ã‚¹")) return "åœ°åŸŸå†…éƒ¨ã®æ¥­å‹™åŠ¹ç‡ãƒ»é€£æºå¼·åŒ–ãƒ»åˆ¶åº¦æ”¹å–„ãªã©ä»•çµ„ã¿ã®æ•´å‚™";
  if (perspective.includes("å­¦ç¿’")) return "äººæãƒ»æƒ…å ±ãƒ»æ–‡åŒ–è³‡ç”£ãªã©å°†æ¥ã®åŠ›ã‚’é«˜ã‚ã‚‹åŸºç›¤ã®å½¢æˆ";
  return "è¦–ç‚¹ã«å¿œã˜ãŸæ³¨é‡ˆã‚’è¨­å®šã—ã¦ãã ã•ã„";
}

function createCard(item) {
  const card = document.createElement("div");
  card.className = "card";

  const header = document.createElement("div");
  header.className = "card-header";

  const perspective = item.viewpoint || "";
  const tag = document.createElement("span");
  tag.className = "viewpoint-tag viewpoint-" + convertTagClass(perspective);
  tag.innerText = getFullPerspectiveName(perspective);

  const desc = document.createElement("span");
  desc.className = "viewpoint-desc";
  desc.innerText = getPerspectiveAnnotation(perspective);

  header.appendChild(tag);
  header.appendChild(desc);

  const title = document.createElement("h2");
  title.innerText = item.strategy || "æˆ¦ç•¥æœªè¨­å®š";

  const detailButton = document.createElement("button");
  detailButton.className = "detail-button";
  detailButton.innerText = "è©³ç´°ã‚’è¦‹ã‚‹";
  detailButton.onclick = () => {
    openModal(
      item.strategy || "æˆ¦ç•¥æœªè¨­å®š",
      item.policy || "æ–½ç­–æƒ…å ±ãªã—",
      item.kpi || "KPIæœªè¨­å®š"
    );
  };

  const priorityButton = document.createElement("button");
priorityButton.className = "add-priority-button";
priorityButton.innerText = "å„ªå…ˆãƒªã‚¹ãƒˆã¸è¿½åŠ ";

// âœ… ä»Šå¾Œæ´»ç”¨äºˆå®šï¼šåˆ¥ãƒ“ãƒ¥ãƒ¼ã«IDä»˜ãã§æ¸¡ã™
priorityButton.onclick = () => {
  const id = item.id || "unknown";
  window.open(`kpi_input_viewer.html?id=${id}`, "_blank");
};
  
  const buttonArea = document.createElement("div");
  buttonArea.style.display = "flex";
  buttonArea.style.flexDirection = "column";
  buttonArea.style.alignItems = "center";
  buttonArea.style.gap = "0.3rem";
  buttonArea.style.marginTop = "1rem";
  buttonArea.appendChild(detailButton);
  buttonArea.appendChild(priorityButton);

  card.appendChild(header);
  card.appendChild(title);
  card.appendChild(buttonArea);

  return card;
}

  function openModal(title, content, kpi) {
  const modal = document.getElementById("detail-modal");
  document.getElementById("modal-title").innerText = title;
  document.getElementById("modal-content").innerText = content;
  document.getElementById("modal-kpi").innerText = kpi;
  modal.style.display = "block";
}

function closeModal() {
  document.getElementById("detail-modal").style.display = "none";
}

  window.addEventListener("DOMContentLoaded", () => {
  const sessionKey = localStorage.getItem("selectedSessionKey");
  const sessionData = sessionKey ? JSON.parse(localStorage.getItem(sessionKey)) : null;
  if (sessionData?.mindmapImageData) {
    // ã“ã“ã«å¿…è¦ãªå‡¦ç†ãŒã‚ã‚Œã°å…¥ã‚Œã¦OK
  }
});
</script>

<!-- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLã¯ script ã‚¿ã‚°ã®"å¤–å´" ã«æ›¸ãï¼ -->
<div id="detail-modal" style="
  display: none;
  position: fixed;
  z-index: 9999;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  max-width: 700px;
  width: 90%;
">
  <h2 id="modal-title">è©³ç´°ã‚¿ã‚¤ãƒˆãƒ«</h2>
  <p><strong>æ–½ç­–ï¼š</strong> <span id="modal-content"></span></p>
  <p><strong>KPIï¼š</strong> <span id="modal-kpi"></span></p>
  <button onclick="closeModal()" style="
    margin-top: 1rem;
    background: #007bff;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
  ">é–‰ã˜ã‚‹</button>
</div>


</body>
</html>
