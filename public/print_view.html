<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>SORAå°åˆ·ãƒ“ãƒ¥ãƒ¼</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
    }
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .section h3 {
      margin-top: 0;
      font-size: 1.2em;
    }
    .output-box {
      white-space: pre-wrap;
      line-height: 1.6em;
    }
    #mindmapContainer {
      width: 100%;
      height: 600px;
      border: 1px dashed #ccc;
      border-radius: 8px;
      background: #fff;
    }
    .output-controls {
      text-align: right;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="section">
  <h3>åœ°åŸŸã¨ãƒ†ãƒ¼ãƒ</h3>
  <p id="regionThemeOutput">-</p>
</div>

<div class="section">
  <h3>èª²é¡Œãƒªã‚¹ãƒˆ</h3>
  <div id="taskListOutput" class="output-box">-</div>
</div>

<div class="section">
  <h3>ä½æ°‘ã®è€ƒå¯Ÿ</h3>
  <div id="insightOutput" class="output-box">-</div>
</div>

<div class="section">
  <h3>ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—</h3>
  <div id="mindmapContainer">ã“ã“ã«ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã‚’å†æç”»</div>
  <div class="output-controls">
    <button onclick="saveAsPNG()">PNGã§ä¿å­˜</button>
    <button onclick="saveAsPDF()">PDFã§å‡ºåŠ›</button>
  </div>
</div>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/mind-elixir/dist/mind-elixir.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
window.onload = () => {
  const raw = localStorage.getItem("session_001");
  if (!raw) return alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“");

  const session = JSON.parse(raw);

  document.getElementById("regionThemeOutput").textContent =
    `${session.region} Ã— ${session.theme}`;

  document.getElementById("taskListOutput").textContent =
    (session.tasks || []).map((t, i) => `â— ${t}`).join("\n");

  document.getElementById("insightOutput").textContent =
    session.insight || "æœªå…¥åŠ›";

  // ğŸ’¡ ä¿é™ºï¼šæç”»å‰ã« container ã‚’ãƒªã‚»ãƒƒãƒˆ
  const container = document.getElementById("mindmapContainer");
  container.innerHTML = "";

  if (session.mindmapData && Object.keys(session.mindmapData).length > 0) {
    // ğŸ’¡ ä¿é™ºï¼štopicãŒæ¶ˆãˆã¦ã„ãŸã‚‰ä»£æ›¿
    session.mindmapData.topic = session.mindmapData.topic || "ï¼ˆç„¡é¡Œï¼‰";

    const mind = new MindElixir({
      el: "#mindmapContainer",
      direction: MindElixir.LEFT,
      data: session.mindmapData,
      draggable: false,
      contextMenu: false,
      toolBar: false,
      nodeMenu: false,
      keypress: false,
    });
    mind.init();
  }
};

// PNGå‡ºåŠ›
function saveAsPNG() {
  html2canvas(document.getElementById("mindmapContainer")).then(canvas => {
    const link = document.createElement("a");
    link.download = "mindmap.png";
    link.href = canvas.toDataURL();
    link.click();
  });
}

// PDFå‡ºåŠ›
function saveAsPDF() {
  html2canvas(document.getElementById("mindmapContainer")).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("landscape", "mm", "a4");
    pdf.addImage(imgData, "PNG", 10, 10, 270, 190);
    pdf.save("mindmap.pdf");
  });
}
</script>
</body>
</html>
