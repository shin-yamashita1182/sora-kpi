<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>印刷ビューア - 出力統合メニュー</title>

   <!-- ✅ 追加：カード表示用スタイル -->
  <link rel="stylesheet" href="style.css">

  <style>
  /* ===== 画面表示用スタイル ===== */
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f8f9fa;
  }

  header {
    background-color: #0077cc;
    color: white;
    padding: 1rem 2rem;
    font-size: 1.4rem;
    font-weight: bold;
    text-align: center;
  }

  #menu {
    display: flex;
    justify-content: center;
    gap: 1rem;
    padding: 1rem;
    background-color: #e9ecef;
  }

  #menu button {
    background-color: #2a9d8f;
    border: none;
    color: white;
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
  }

  #menu button:hover {
    background-color: #21867a;
  }

  /* ✅ 🎯 印刷ボタンだけ別色に（@media の外に出す！） */
  #menu #printBtn {
    background-color: #6c757d;
    color: white;
  }

  #menu #printBtn:hover {
    background-color: #5a6268;
  }

  #content {
    padding: 2rem;
    text-align: center;
  }

  .section-container {
    margin-top: 2rem;
    border-top: 1px solid #ccc;
    padding-top: 1rem;
  }

  #mindmapMetadata {
    text-align: left;
    margin-bottom: 1rem;
    background: #fff;
    border: 1px solid #ccc;
    padding: 1rem;
    border-radius: 6px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  #mindmapImage {
    display: block;
    margin: 1rem auto;
    max-width: 100%;
    border: 1px solid #999;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  /* ===== 印刷時専用スタイル ===== */
  @media print {
    body * {
      visibility: hidden;
    }

    .print-area,
    .print-area * {
      visibility: visible;
    }

    .print-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: white;
      padding: 2rem;
    }

    header,
    #menu,
    #detailSections {
      display: none !important;
    }
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body>
  <header>🖨️ 印刷・出力ビューア</header>

  <!-- ✅ 総合メニュー -->
  <div id="menu">
    <button onclick="loadSection('mindmap')">🧠 マインドマップ単体</button>
    <button onclick="loadSection('summary')">📊 統合出力（レポート）</button>
    <button onclick="loadSection('cards')">📇 実行策一覧</button>
    <button onclick="loadSection('3d')">🌐 3Dビューア</button>
    <button id="printBtn" onclick="window.print()">🖨️ 印刷</button>  </div>

  <div id="content" class="print-area">
    <p>出力内容を選択してください。</p>
  </div>

  <!-- ✅ 統合出力などの追加UI領域 -->
  <div class="section-container" id="detailSections"></div>

  <script>
 
    function loadSection(type) {
      console.log("loadSection called with type:", type); // ← 追加
      const sessionKey = localStorage.getItem("selectedSessionKey");   
      const sessionData = sessionKey ? JSON.parse(localStorage.getItem(sessionKey)) : null;
      const content = document.getElementById("content");
      const details = document.getElementById("detailSections");
      content.innerHTML = "";
      details.innerHTML = "";

      
  if (type === "mindmap") {
  const region = sessionData?.region || localStorage.getItem("region") || "地域未設定";
  const theme = sessionData?.theme || localStorage.getItem("theme") || "テーマ未設定";
  const imageData = sessionData?.mindmapImageData || sessionData?.png || localStorage.getItem("mindmapImageData");
  const dateStr = new Date().toLocaleDateString();

  // ✅ Base64 PNG形式であることを厳密チェック
  if (!imageData || !imageData.startsWith("data:image/png;base64,")) {
    const warning = document.createElement("p");
    warning.textContent = "❌ マインドマップ画像が存在しません、または形式が不正です。保存に失敗した可能性があります。";
    warning.style.color = "red";
    content.appendChild(warning);
    return;
  }

  // ✅ 表示用のメタデータ（印刷には含めない）
  const metadata = document.createElement("div");
  metadata.id = "mindmapMetadata";
  metadata.innerHTML = `
    <h2>🧠 マインドマップ出力</h2>
    <p><strong>地域名：</strong>${region}</p>
    <p><strong>テーマ：</strong>${theme}</p>
    <p><strong>出力日：</strong>${dateStr}</p>
  `;

  // ✅ PNG画像表示エリア
const img = document.createElement("img");
img.id = "mindmapImage";
img.src = imageData;
img.alt = "マインドマップ画像";

// ✅ スタイル修正（ここが肝！）
img.style.width = "100%";
img.style.maxWidth = "1400px";  // 好みに応じて1200〜1600px程度
img.style.height = "auto";
img.style.display = "block";
img.style.margin = "1rem auto";
img.style.border = "1px solid #ccc";
img.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";

  // ✅ 印刷対象としてラップ
  const printable = document.createElement("div");
  printable.className = "print-area";
  printable.appendChild(img);

  // ✅ 画面表示に追加
  content.appendChild(metadata);
  content.appendChild(printable);
  details.innerHTML = "<p style='margin-top: 1rem;'>このマインドマップは、地域の課題と構造的な思考を可視化した資料です。今後の対策立案や共有に活用できます。</p>";

  
      } else if (type === "summary") {
  const region = sessionData?.region || "地域未設定";
  const theme = sessionData?.theme || "テーマ未設定";
  const tasks = sessionData?.tasks || [];
  const category = sessionData?.category || "分類未設定";
  const insightRaw = sessionData?.insight || [];
  const insights = Array.isArray(insightRaw)
    ? insightRaw.map(line => `・${line}`).join("<br>")
    : insightRaw || "（未入力）";
  const imageData = sessionData?.mindmapImageData || "";
  const nexcoInfo = sessionData?.nexcoInfo || "[NEXCO情報はまだ登録されていません]";
  const mapImageData = sessionData?.mapImageData || "";

  const heading = document.createElement("h2");
  heading.textContent = "📊 総合出力レポート";

  const printable = document.createElement("div");
  printable.className = "print-area";
  printable.style.textAlign = "left";

  // 地域名＋テーマ＋分類
  printable.innerHTML += `<h3>地域名：${region}</h3><p><strong>テーマ：</strong>${theme}</p><p><strong>分類：</strong>${category}</p>`;

  // 課題
  if (Array.isArray(tasks) && tasks.length > 0) {
    printable.innerHTML += "<h4>抽出された10の課題：</h4><ol>";
    tasks.forEach(task => {
      printable.innerHTML += `<li>${task}</li>`;
    });
    printable.innerHTML += "</ol>";
  }

  // 考察
  printable.innerHTML += `<h4>住民の考察・分析コメント：</h4><p>${insights}</p>`;

 // 地域名に基づいたGoogleマップ表示
const mapQuery = encodeURIComponent(region);
printable.innerHTML += `
  <h4>地域マップ：</h4>
  <iframe
    width="100%"
    height="300"
    style="border:1px solid #ccc; border-radius:8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);"
    loading="lazy"
    allowfullscreen
    referrerpolicy="no-referrer-when-downgrade"
    src="https://maps.google.com/maps?q=${mapQuery}&output=embed">
  </iframe>
`;

  // マインドマップ
  if (imageData) {
  printable.innerHTML += `<h4>マインドマップ：</h4>
<img src="${imageData}" alt="マインドマップ" 
style="width:100%; max-width:1400px; height:auto; border:1px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display:block; margin:1rem auto;">`;
  }

  // NEXCO情報
  printable.innerHTML += `<h4>NEXCO連携情報：</h4><p>${nexcoInfo}</p>`;

  content.appendChild(heading);
  content.appendChild(printable);
  details.innerHTML = "<p>このエリアには地域全体の課題構造と住民の分析を統合表示します。</p>";

    
     } else if (type === "cards") {
  const heading = document.createElement("h2");
  heading.textContent = "📇 実行策一覧出力（MindTriggerカード）";

  const cardContainer = document.createElement("div");
  cardContainer.className = "print-area";
  cardContainer.style.display = "flex";
  cardContainer.style.flexWrap = "wrap";
  cardContainer.style.gap = "1rem";
  cardContainer.style.justifyContent = "flex-start";

  // ✅ 正しいパス（public/test-validation/ にあるファイルを読む）
  fetch("test-validation/coremaster_real_401cards.json")
    .then(res => res.json())
    .then(strategyCards => {
      strategyCards.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="viewpoint-tag viewpoint-${convertTagClass(item.perspective)}">${item.perspective}</div>
          <div class="viewpoint-desc">${item.annotation || ""}</div>
          <h2>${item.strategy}</h2>
          <p>${item.policy || "（施策内容なし）"}</p>
          <p style="color:gray; font-size:0.85rem;">KPI：${item.kpi || "未設定"}</p>
        `;

        cardContainer.appendChild(card);
      });

      content.appendChild(heading);
      content.appendChild(cardContainer);

      details.innerHTML = "<p>このセクションには、<strong>test-validationホルダーの本物カード</strong>を直接参照して出力しています。</p>";
    })
    .catch(err => {
      content.appendChild(heading);
      const warning = document.createElement("p");
      warning.textContent = "❌ カードデータの取得に失敗しました。パスまたはファイルの確認をしてください。";
      warning.style.color = "red";
      content.appendChild(warning);
    });

      
 } else if (type === "3d") {
    window.open("3d_viewer.html", "_blank");
  }
} // ✅ ← loadSection() 関数をここで正しく閉じる！

    
function convertTagClass(perspective) {
  if (perspective.includes("財務")) return "finance";
  if (perspective.includes("顧客")) return "customer";
  if (perspective.includes("プロセス")) return "process";
  if (perspective.includes("学習")) return "growth";
  return "finance"; // fallback
}
     
    window.addEventListener("DOMContentLoaded", () => {
  const sessionKey = localStorage.getItem("selectedSessionKey");
  const sessionData = sessionKey ? JSON.parse(localStorage.getItem(sessionKey)) : null;
  if (sessionData?.mindmapImageData) {
   
  }
});
  </script>
</body>
</html>
