<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>SORA印刷ビュー</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
    }
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .section h3 {
      margin-top: 0;
      font-size: 1.2em;
    }
    .output-box {
      white-space: pre-wrap;
      line-height: 1.6em;
    }
    #mindmapContainer {
      width: 100%;
      height: 600px;
      border: 1px dashed #ccc;
      border-radius: 8px;
      background: #fff;
    }
    .output-controls {
      text-align: right;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="section">
  <h3>地域とテーマ</h3>
  <p id="regionThemeOutput">-</p>
</div>

<div class="section">
  <h3>課題リスト</h3>
  <div id="taskListOutput" class="output-box">-</div>
</div>

<div class="section">
  <h3>住民の考察</h3>
  <div id="insightOutput" class="output-box">-</div>
</div>

<div class="section">
  <h3>マインドマップ</h3>
  <div id="mindmapContainer">ここにマインドマップを再描画</div>
  <div class="output-controls">
    <button onclick="saveAsPNG()">PNGで保存</button>
    <button onclick="saveAsPDF()">PDFで出力</button>
  </div>
</div>

<!-- ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/mind-elixir/dist/mind-elixir.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
window.onload = () => {
  const raw = localStorage.getItem("session_001");
  if (!raw) return alert("セッションが存在しません");

  const session = JSON.parse(raw);

  document.getElementById("regionThemeOutput").textContent =
    `${session.region} × ${session.theme}`;

  document.getElementById("taskListOutput").textContent =
    (session.tasks || []).map((t, i) => `● ${t}`).join("\n");

  document.getElementById("insightOutput").textContent =
    session.insight || "未入力";

  // 💡 保険：描画前に container をリセット
  const container = document.getElementById("mindmapContainer");
  container.innerHTML = "";

  if (session.mindmapData && Object.keys(session.mindmapData).length > 0) {
    // 💡 保険：topicが消えていたら代替
    session.mindmapData.topic = session.mindmapData.topic || "（無題）";

    const mind = new MindElixir({
      el: "#mindmapContainer",
      direction: MindElixir.LEFT,
      data: session.mindmapData,
      draggable: false,
      contextMenu: false,
      toolBar: false,
      nodeMenu: false,
      keypress: false,
    });
    mind.init();
  }
};

// PNG出力
function saveAsPNG() {
  html2canvas(document.getElementById("mindmapContainer")).then(canvas => {
    const link = document.createElement("a");
    link.download = "mindmap.png";
    link.href = canvas.toDataURL();
    link.click();
  });
}

// PDF出力
function saveAsPDF() {
  html2canvas(document.getElementById("mindmapContainer")).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("landscape", "mm", "a4");
    pdf.addImage(imgData, "PNG", 10, 10, 270, 190);
    pdf.save("mindmap.pdf");
  });
}
</script>
</body>
</html>
